{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/mypage.css' %}">
{% endblock %}

{% block content %}
<div style="text-align:center; color:white;">
  <h2>マイページ</h2>

  <h3>ジャンル別訪問数</h3>
  <img src="/savoiry/restaurants/visit_chart/genre/" 
     alt="ジャンル別訪問グラフ"
     style="width:100%; max-width:500px; border-radius:8px; background:white; border:1px solid #ccc; padding:8px;">


  <h3>月別訪問数</h3>
  <img src="/savoiry/restaurants/visit_chart/monthly/" 
     alt="月別訪問グラフ"
     style="width:90%; max-width:600px; background:white; border-radius:8px; padding:10px;">

  <h3>お気に入りのお店 TOP3</h3>
<div class="top3-container">
  {% for visit in top3_visits %}
    <div class="top3-item">
      <div class="rank">No.{{ forloop.counter }}</div>
      <div class="info">
        <div class="name">{{ visit.restaurant__store_name }}</div>
        <div class="genre">{{ visit.restaurant__genre|default:"未分類" }}</div>
      </div>
      <div class="rating">
        <span class="star">★</span>
        <span class="score">{{ visit.avg_rating|floatformat:0 }}</span>
      </div>
    </div>
  {% empty %}
    <p class="no-data2">データがありません</p>
  {% endfor %}
</div>

<a href="{% url 'accounts:email_change' %}" class="account-item">
  <div class="left">
    <img src="{% static 'icons/mail.png' %}" alt="key icon" class="icon">
    <span class="text">メールアドレスを変更</span>
  </div>
  <span class="arrow">＞</span>
</a>

<a href="{% url 'accounts:password_change' %}" class="account-item">
  <div class="left">
    <img src="{% static 'icons/key.png' %}" alt="key icon" class="icon">
    <span class="text">パスワードを変更</span>
  </div>
  <span class="arrow">＞</span>
</a>

<form method="post" class="logout-item-form">
  {% csrf_token %}
  <button type="button" class="logout-item open-logout-modal">
    <div class="left">
      <img src="{% static 'icons/logout.png' %}" alt="door icon" class="icon">
      <span class="text">ログアウト</span>
    </div>
  </button>
</form>

<!-- ★ ログアウト確認モーダル -->
<div id="logout-modal" class="confirm-modal">
  <div class="confirm-content">
    <p>ログアウトしますか？</p>

    <div class="confirm-buttons">
      <button type="button" class="btn-cancel" id="cancel-logout">
        キャンセル
      </button>
      <button type="button" class="btn-ok" id="confirm-logout">
        ログアウト
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const modal = document.getElementById("logout-modal");
  const openBtn = document.querySelector(".open-logout-modal");
  const cancelBtn = document.getElementById("cancel-logout");
  const okBtn = document.getElementById("confirm-logout");

  if (!modal || !openBtn) return;

  // モーダルを開く
  openBtn.addEventListener("click", () => {
    modal.style.display = "flex";
  });

  // キャンセル
  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  // ログアウト実行
  okBtn.addEventListener("click", () => {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "{% url 'accounts:logout' %}";

    // CSRFトークン
    const csrf = document.querySelector("[name=csrfmiddlewaretoken]").cloneNode(true);
    form.appendChild(csrf);

    document.body.appendChild(form);
    form.submit();
  });

});
</script>


{% endblock %}
<button type="submit" class="logout-item"
            onclick="return confirm('ログアウトしますか？');">
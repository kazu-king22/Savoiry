{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'restaurants/css/detail.css' %}">
{% endblock %}

{% block content %}
<div class="detail-container">
  <div class="detail-card">

  
  <div class="restaurant-info">
    <h2>{{ restaurant.store_name }}</h2>

    {% if restaurant.url %}
      {% if "instagram.com" in restaurant.url %}
        <blockquote class="instagram-media"
                    data-instgrm-permalink="{{ restaurant.url }}"
                    data-instgrm-version="14"></blockquote>
        <script async src="//www.instagram.com/embed.js"></script>
      {% elif "tiktok.com" in restaurant.url %}
        <blockquote class="tiktok-embed" cite="{{ restaurant.url }}">
          <a href="{{ restaurant.url }}">TikTokを開く</a>
        </blockquote>
        <script async src="https://www.tiktok.com/embed.js"></script>
      {% else %}
        <a href="{{ restaurant.url }}" target="_blank">{{ restaurant.url }}</a>
      {% endif %}
    {% endif %}

    <div class="restaurant-details">
  <p class="line">
    {% if restaurant.area %}{{ restaurant.area }}{% endif %}
    {% if restaurant.genre %}　{{ restaurant.genre }}{% endif %}
    {% if restaurant.scene %}　{{ restaurant.scene }}{% endif %}
    {% if restaurant.companions %}　{{ restaurant.companions }}{% endif %}
  </p>

  {% if restaurant.tags.all %}
  <p class="line">
    {% for tag in restaurant.tags.all %}
      {{ tag.name }}{% if not forloop.last %}　{% endif %}
    {% endfor %}
  </p>
  {% endif %}

  {% if restaurant.holiday %}
  <p class="line">休業日　{{ restaurant.holiday }}</p>
  {% endif %}
</div>


<div class="edit-btn-wrapper">
  <a href="{% url 'restaurants:restaurant_edit' restaurant.pk %}" class="edit-btn">
    店舗情報を編集
  </a>
</div>


    <a href="{% url 'restaurants:restaurant_list_want' %}" class="back-link">← 一覧へ戻る</a>
  </div>

  <!-- 訪問記録フォーム -->
  <div class="visit-form-section">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="photo-upload">
  <label for="id_images" class="upload-label">＋</label>
  <input type="file" name="images" id="id_images" multiple hidden>
  <p class="upload-text">写真を追加<br>(1回の訪問につき5枚まで)</p>
  <div id="image-count" class="image-count"></div>
</div>

<!-- 新規プレビュー（ここに JS が生成して追加する） -->
<div id="preview-area" class="existing-image-list"></div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const imageInput = document.getElementById('id_images');
  const imageCount = document.getElementById('image-count');
  imageInput.addEventListener('change', function() {
    const count = this.files.length;
    imageCount.textContent = count > 0 ? `${count}枚選択中` : '';
  });
});
</script>


<div class="visit-date-section">
  <label for="id_date">訪問日（必須）</label>

  <div class="date-wrapper">
    <input type="date" name="date" id="id_date" class="visit-date" required>
    <span class="date-placeholder">選択してください</span>
  </div>

  <!-- ★ 日付エラー表示（未来日禁止など） -->
  {% if form.date.errors %}
    <p class="error-text">{{ form.date.errors.0 }}</p>
  {% endif %}
</div>




      <textarea name="comment" placeholder="感想・思い出を入力" class="comment-box"></textarea>

<div class="rating">
  <p>お気に入り度</p>
  <div class="stars">
    <span class="star" data-value="1">★</span>
    <span class="star" data-value="2">★</span>
    <span class="star" data-value="3">★</span>
    <span class="star" data-value="4">★</span>
    <span class="star" data-value="5">★</span>
  </div>
  <input type="hidden" name="rating" id="rating-value" value="">
</div>

<div class="feeling-select">
  <label for="id_feeling">気持ち評価</label>
  <select name="feeling" id="id_feeling">
    <option value="">選択してください</option>
    <option value="again">また行きたい</option>
    <option value="recommend">おすすめしたい</option>
    <option value="no">もう行かない</option>
  </select>
</div>

<button type="submit" class="btn-went">行った</button>
</form>

<!-- 削除ボタン：モーダルを開くだけ -->
<button type="button"
        class="btn-delete open-shop-delete-modal"
        data-delete-url="{% url 'restaurants:restaurant_delete' restaurant.pk %}">
  削除
</button>

  </div>
  <p class="note">※このボタンを押すと、<br>「気になる一覧」から削除されます。</p>
 </div>
</div>

<div class="back-link">
  <a href="{% url 'restaurants:restaurant_list_want' %}">一覧へ戻る</a>
</div>

<!-- 画像拡大モーダル -->
<div id="image-modal" class="image-modal">
  <span class="close-modal">×</span>
  <img id="modal-img" class="modal-content">
</div>


<script src="{% static 'restaurants/js/star_rating.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const modal   = document.getElementById("image-modal");
  const modalImg = document.getElementById("modal-img");
  const closeBtn = document.querySelector(".close-modal");

  // ▼ ここを修正：.visit-photo を対象にする
  const thumbnails = document.querySelectorAll(".visit-photo");

  thumbnails.forEach((img) => {
    img.addEventListener("click", function () {
      modal.style.display = "flex";
      modalImg.src = this.src;
    });
  });

  // ✕で閉じる
  if (closeBtn) {
    closeBtn.addEventListener("click", function () {
      modal.style.display = "none";
    });
  }

  // 背景クリックでも閉じる
  modal.addEventListener("click", function (e) {
    if (e.target === modal) {
      modal.style.display = "none";
    }
  });
});
</script>

<!-- 店舗削除モーダル（このページ専用） -->
<div id="shop-delete-modal" class="confirm-modal">
  <div class="confirm-content">
    <p>本当にこのお店を削除しますか？</p>

    <div class="confirm-buttons">
      <button type="button" class="btn-cancel" id="cancel-shop-delete">キャンセル</button>
      <button type="button" class="btn-ok" id="confirm-shop-delete">削除する</button>
    </div>
  </div>
</div>

<!-- ★ 写真削除用モーダル（新規追加） -->
<div id="photo-delete-modal" class="confirm-modal">
  <div class="confirm-content">
    <p>この写真を削除しますか？</p>
    <div class="confirm-buttons">
      <button type="button" id="cancel-photo-delete" class="btn-cancel">キャンセル</button>
      <button type="button" id="confirm-photo-delete" class="btn-ok">削除する</button>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {

  const modal = document.getElementById("shop-delete-modal");
  const cancelBtn = document.getElementById("cancel-shop-delete");
  const okBtn = document.getElementById("confirm-shop-delete");

  let deleteUrl = null;

  // 削除ボタンを押したとき → モーダル表示
  document.querySelector(".open-shop-delete-modal").addEventListener("click", function() {
    deleteUrl = this.dataset.deleteUrl;
    modal.style.display = "flex";
  });

  // キャンセル
  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  // 削除実行
  okBtn.addEventListener("click", () => {
    if (!deleteUrl) return;

    const form = document.createElement("form");
    form.method = "POST";
    form.action = deleteUrl;

    // CSRF挿入
    const csrf = document.querySelector("[name=csrfmiddlewaretoken]").cloneNode(true);
    form.appendChild(csrf);

    document.body.appendChild(form);
    form.submit();
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("id_images");
  const preview = document.getElementById("preview-area");
  const countLabel = document.getElementById("image-count");

  // モーダル
  const modal = document.getElementById("photo-delete-modal");
  const cancelBtn = document.getElementById("cancel-photo-delete");
  const okBtn = document.getElementById("confirm-photo-delete");

  let fileArray = [];      // FileList のコピー
  let deleteIndex = null;  // 削除対象

  input.addEventListener("change", () => {
    fileArray = Array.from(input.files);

    // 枚数ラベル更新
    countLabel.textContent = fileArray.length > 0 ? `${fileArray.length}枚選択中` : "";

    // プレビューを一旦全部クリア
    preview.innerHTML = "";

    // プレビュー生成
    fileArray.forEach((file, index) => {
      const reader = new FileReader();

      reader.onload = (e) => {
        const item = document.createElement("div");
        item.className = "existing-image-item";

        // 画像
        const img = document.createElement("img");
        img.src = e.target.result;
        img.className = "visit-photo";

        // 拡大モーダルも既存写真と同じ動作
        img.addEventListener("click", () => {
          const modalImage = document.getElementById("modal-img");
          const modalBase = document.getElementById("image-modal");
          modalBase.style.display = "flex";
          modalImage.src = img.src;
        });

        // × ボタン（→ 確認モーダルへ）
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "delete-image-btn";
        delBtn.textContent = "×";
        delBtn.dataset.index = index;

        delBtn.addEventListener("click", () => {
          deleteIndex = index;
          modal.style.display = "flex";  // 確認モーダル表示
        });

        item.appendChild(img);
        item.appendChild(delBtn);
        preview.appendChild(item);
      };

      reader.readAsDataURL(file);
    });
  });

  // キャンセル → モーダル閉じる
  cancelBtn.addEventListener("click", () => {
    modal.style.display = "none";
    deleteIndex = null;
  });

  // 削除実行
  okBtn.addEventListener("click", () => {
    if (deleteIndex === null) return;

    // FileList 再構築
    fileArray.splice(deleteIndex, 1);
    const dt = new DataTransfer();
    fileArray.forEach(f => dt.items.add(f));
    input.files = dt.files;

    // プレビュー作り直す
    input.dispatchEvent(new Event("change"));

    // モーダル閉じる
    modal.style.display = "none";
    deleteIndex = null;
  });
});
</script>


{% endblock %}
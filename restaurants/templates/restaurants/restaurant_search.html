{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'restaurants/css/search.css' %}">
{% endblock %}

{% block content %}
<div class="search-page">

  <div class="status-box">
    <p>気になる：{{ want_count|default:"0" }}件</p>
    <p>行った：{{ went_count|default:"0" }}件</p>
  </div>

  <div class="search-form">
    <h2>お店の検索</h2>

    <form method="get" action="{% url 'restaurants:restaurant_search_results' %}">

      <!-- エリア -->
      <p>
        <label>エリア（必須）</label><br>
        <div class="input-wrapper">
          <input type="text" name="area" list="area-list"
                 placeholder="例：渋谷・天神など"
                 value="{{ request.GET.area }}"
                 required>
        </div>
      </p>

      <!-- ジャンル -->
      <p>
        <label>ジャンル（必須）</label><br>
        <div class="input-wrapper">
          <input type="text" name="genre" list="genre-list"
                 placeholder="例：ラーメン・カフェなど"
                 value="{{ request.GET.genre }}"
                 required>
        </div>
      </p>

      <!-- グループ -->
      <p>
        <label>グループ</label><br>
        <div class="input-wrapper">
          <input type="text" name="companions" list="group-list"
                 placeholder="例：友人・家族など"
                 value="{{ request.GET.companions }}">
        </div>
      </p>

      <!-- シーン -->
      <p>
        <label>シーン</label><br>
        <div class="input-wrapper">
          <input type="text" name="scene" list="scene-list"
                 placeholder="例：ランチ・デートなど"
                 value="{{ request.GET.scene }}">
        </div>
      </p>


      <!-- 休業日（カスタム UI） -->
      <p>
        <label for="holiday-box">休業日</label>

        <div id="holiday-box" class="holiday-box"
             data-initial="{% if request.GET.holiday %}{{ request.GET.holiday|join:'、' }}{% endif %}">
          <span class="holiday-text">選択してください</span>
          <span class="holiday-arrow">▼</span>
        </div>
      </p>

      <div id="holiday-options" class="holiday-options hidden">
        <div class="holiday-option" data-value="月">月曜日</div>
        <div class="holiday-option" data-value="火">火曜日</div>
        <div class="holiday-option" data-value="水">水曜日</div>
        <div class="holiday-option" data-value="木">木曜日</div>
        <div class="holiday-option" data-value="金">金曜日</div>
        <div class="holiday-option" data-value="土">土曜日</div>
        <div class="holiday-option" data-value="日">日曜日</div>
        <div class="holiday-option" data-value="祝日">祝日</div>
        <div class="holiday-option" data-value="年中無休">年中無休</div>
        <div class="holiday-option" data-value="不定休">不定休</div>
      </div>

      <!-- hidden inputs -->
      <div id="holiday-hidden-container"></div>


      <!-- タグ -->
      <p>
        <label>タグ</label><br>
        <div class="input-wrapper">
          <input type="text" name="tag" list="tag-list"
                 placeholder="例：おしゃれ・個室など"
                 value="{{ request.GET.tag }}">
        </div>
      </p>


      <!-- ステータス -->
      <div class="radio-group">
        <label>
          <input type="radio" name="status" value="want"
                 {% if request.GET.status == 'want' %}checked{% endif %}> 気になる
        </label>
        <label>
          <input type="radio" name="status" value="went"
                 {% if request.GET.status == 'went' %}checked{% endif %}> 行った
        </label>
        <label>
          <input type="radio" name="status" value="all"
                 {% if request.GET.status == 'all' %}checked{% endif %}> 全て
        </label>
      </div>

      <p><button type="submit">検索</button></p>

    </form>
  </div>
</div>


<!-- ▼ datalist -->
<datalist id="area-list">
  {% for w in area_list %}
    <option value="{{ w }}">
  {% endfor %}
</datalist>

<datalist id="genre-list">
  {% for w in genre_list %}
    <option value="{{ w }}">
  {% endfor %}
</datalist>

<datalist id="group-list">
  {% for w in group_list %}
    <option value="{{ w }}">
  {% endfor %}
</datalist>

<datalist id="scene-list">
  {% for w in scene_list %}
    <option value="{{ w }}">
  {% endfor %}
</datalist>

<datalist id="tag-list">
  {% for w in tag_list %}
    <option value="{{ w }}">
  {% endfor %}
</datalist>


<!-- ▼ JS：休業日（カスタム UI） -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const box = document.getElementById("holiday-box");
  const list = document.getElementById("holiday-options");
  const hiddenContainer = document.getElementById("holiday-hidden-container");

  if (!box || !list || !hiddenContainer) return;

  // 表示テキスト用
  const text = box.querySelector(".holiday-text");

  /* =========================
     初期値反映
  ========================= */
  const initial = box.dataset.initial;

  if (initial) {
    const initialValues = initial.split("、").map(s => s.trim());
    text.textContent = initial;

    list.querySelectorAll(".holiday-option").forEach(opt => {
      if (initialValues.includes(opt.dataset.value)) {
        opt.classList.add("selected");

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "holiday";
        input.value = opt.dataset.value;
        hiddenContainer.appendChild(input);
      }
    });
  }

  /* =========================
     開閉処理
  ========================= */
  box.addEventListener("click", function () {
    list.classList.toggle("hidden");
    box.classList.toggle("open"); // 矢印回転用
  });

  /* =========================
     選択処理
  ========================= */
  list.querySelectorAll(".holiday-option").forEach(opt => {
    opt.addEventListener("click", function (e) {
      e.stopPropagation(); // ← boxクリックと干渉させない

      opt.classList.toggle("selected");

      // hidden input 初期化
      hiddenContainer.innerHTML = "";

      const selected = Array.from(
        list.querySelectorAll(".holiday-option.selected")
      ).map(item => item.dataset.value);

      // 表示テキスト更新
      text.textContent = selected.length
        ? selected.join("、")
        : "選択してください";

      // hidden input 再生成
      selected.forEach(value => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "holiday";
        input.value = value;
        hiddenContainer.appendChild(input);
      });
    });
  });

});
</script>



{% endblock %}

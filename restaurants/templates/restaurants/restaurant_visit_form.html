{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'restaurants/css/detail.css' %}">
{% endblock %}

{% block content %}
<div class="detail-container">
  <div class="detail-card">

    <!-- 店舗情報 -->
    <div class="restaurant-info">
      <h2>{{ restaurant.store_name }}</h2>

      {% if restaurant.url %}
        {% if "instagram.com" in restaurant.url %}
          <blockquote class="instagram-media"
            data-instgrm-permalink="{{ restaurant.url }}"
            data-instgrm-version="14"></blockquote>
          <script async src="//www.instagram.com/embed.js"></script>
        {% elif "tiktok.com" in restaurant.url %}
          <blockquote class="tiktok-embed" cite="{{ restaurant.url }}">
            <a href="{{ restaurant.url }}">TikTokを開く</a>
          </blockquote>
          <script async src="https://www.tiktok.com/embed.js"></script>
        {% else %}
          <p class="store-url">
            <a href="{{ restaurant.url }}" target="_blank" rel="noopener noreferrer">
              登録したサイトを見る
            </a>
          </p>
        {% endif %}
      {% endif %}

      <div class="restaurant-details">
        <p class="line">
          {% if restaurant.area %}{{ restaurant.area }}{% endif %}
          {% if restaurant.genre %}　{{ restaurant.genre }}{% endif %}
          {% if restaurant.scene %}　{{ restaurant.scene }}{% endif %}
          {% if restaurant.companions %}　{{ restaurant.companions }}{% endif %}
        </p>

        {% if restaurant.tags.all %}
          <p class="line">
            {% for tag in restaurant.tags.all %}
              {{ tag.name }}{% if not forloop.last %}　{% endif %}
            {% endfor %}
          </p>
        {% endif %}

        {% if restaurant.holiday %}
          <p class="line">休業日　{{ restaurant.holiday }}</p>
        {% endif %}
      </div>

      <a href="{% url 'restaurants:restaurant_list_want' %}" class="back-link">
        ← 一覧へ戻る
      </a>
    </div>

    <!-- 訪問フォーム -->
    <div class="visit-form-section">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- 写真アップロード -->
        <div class="photo-upload">
          <label for="id_images" class="upload-label">＋</label>

          <input
            type="file"
            name="images"
            id="id_images"
            multiple
            hidden
            data-existing-count="{% if is_edit %}{{ original_visit.images.count }}{% else %}0{% endif %}"
          >

          <p class="upload-text">
            写真を追加<br>(1回の訪問につき5枚まで)
          </p>

          <div id="image-count" class="image-count"></div>
        </div>

        {% if is_edit %}
        <!-- 登録済み画像 -->
        <div class="existing-images">
          <p>登録済みの写真（{{ original_visit.images.count }}枚）</p>

          <div class="existing-image-list">
            {% for img in original_visit.images.all %}
              <div class="existing-image-item" id="image-{{ img.id }}">
                <img src="{{ img.image.url }}" class="visit-photo" alt="登録済み写真">

                <button type="button"
                  class="delete-image-btn"
                  data-image-id="{{ img.id }}">
                  ×
                </button>
              </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- 訪問日 -->
        <div class="visit-date-section">
          <label for="id_date">訪問日（必須）</label>

          {% if is_edit %}
            <input type="date" name="date" id="id_date"
              class="visit-date"
              value="{{ original_visit.date|date:'Y-m-d' }}">
          {% else %}
            <div class="date-wrapper">
              <input type="date" name="date" id="id_date"
                class="visit-date" required>
              <span class="date-placeholder">選択してください</span>
            </div>
          {% endif %}

          {% if form.date.errors %}
            <p class="error-text" style="color:red;">
              {{ form.date.errors.0 }}
            </p>
          {% endif %}
        </div>

        <!-- コメント -->
        <textarea name="comment" class="comment-box"
          placeholder="感想・思い出を入力">{% if is_edit %}{{ original_visit.comment }}{% endif %}</textarea>

        <!-- 星評価 -->
        <div class="stars">
          {% for i in "12345" %}
            {% with num=forloop.counter %}
              <span class="star {% if is_edit and original_visit.rating|add:0 >= num %}filled{% endif %}"
                data-value="{{ num }}">★</span>
            {% endwith %}
          {% endfor %}
        </div>

        <input type="hidden" name="rating" id="rating-value"
          value="{{ original_visit.rating|default_if_none:0 }}">

        <!-- 気持ち評価 -->
        <div class="feeling-select">
          <label for="id_feeling">気持ち評価</label>
          <select name="feeling" id="id_feeling">
            <option value="">選択してください</option>
            <option value="again" {% if is_edit and original_visit.feeling == 'again' %}selected{% endif %}>また行きたい</option>
            <option value="recommend" {% if is_edit and original_visit.feeling == 'recommend' %}selected{% endif %}>おすすめしたい</option>
            <option value="no" {% if is_edit and original_visit.feeling == 'no' %}selected{% endif %}>もう行かない</option>
          </select>
        </div>

        {% if is_edit %}
          <button type="submit" class="btn-edit">保存</button>
        {% else %}
          <button type="submit" class="btn-went">行った</button>
        {% endif %}

        <a href="{% url 'restaurants:restaurant_detail_went' restaurant.pk %}"
          class="cancel-link">キャンセル</a>

      </form>
    </div>
  </div>
</div>


<!-- 画像拡大モーダル（共通） -->
<div id="image-modal" class="image-modal">
  <span class="close-modal">×</span>
  <img id="modal-img" class="modal-content">
</div>

<!-- 星評価 -->
<script src="{% static 'restaurants/js/star_rating.js' %}"></script>

<!-- 削除確認モーダル -->
<div id="delete-confirm-modal" class="confirm-modal">
  <div class="confirm-content">
    <p>この写真を削除しますか？</p>
    <div class="confirm-buttons">
      <button id="cancel-delete" class="btn-cancel">キャンセル</button>
      <button id="ok-delete" class="btn-ok">削除する</button>
    </div>
  </div>
</div>

<!-- =========================
     画像5枚制限制御JS（唯一）
========================= -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("id_images");
  const label = document.querySelector(".upload-label");
  const display = document.getElementById("image-count");

  if (!input) return;

  const MAX = 5;
  let existingCount = Number(input.dataset.existingCount || 0);

  function update() {
    const newCount = input.files.length;
    const total = existingCount + newCount;

    display.textContent =
      `既存 ${existingCount} 枚 ＋ 新規 ${newCount} 枚（${total}/5）`;

    if (total >= MAX) {
      label.style.pointerEvents = "none";
      label.style.opacity = "0.4";
    } else {
      label.style.pointerEvents = "auto";
      label.style.opacity = "1";
    }

    if (total > MAX) {
      alert("写真は1回の訪問につき5枚までです");
      input.value = "";
      update();
    }
  }

  input.addEventListener("change", update);
  update();

  document.addEventListener("imageDeleted", () => {
    existingCount--;
    if (existingCount < 0) existingCount = 0;
    update();
  });
});
</script>

<!-- 削除処理 -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  let targetId = null;

  document.querySelectorAll(".delete-image-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      targetId = btn.dataset.imageId;
      document.getElementById("delete-confirm-modal").style.display = "flex";
    });
  });

  document.getElementById("cancel-delete").onclick = () => {
    document.getElementById("delete-confirm-modal").style.display = "none";
    targetId = null;
  };

  document.getElementById("ok-delete").onclick = () => {
    fetch(`/savoiry/restaurants/visit/image/${targetId}/delete/`, {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`image-${targetId}`).remove();
        document.dispatchEvent(new Event("imageDeleted"));
      }
    });

    document.getElementById("delete-confirm-modal").style.display = "none";
  };
});
</script>

{% endblock %}

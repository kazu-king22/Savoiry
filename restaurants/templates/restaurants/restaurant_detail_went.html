{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'restaurants/css/detail_went.css' %}">
{% endblock %}

{% block content %}
<div class="detail-container">

 <!-- 写真ギャラリー -->
<div class="photo-gallery">

  {% if has_images %}
    {% for visit in visits %}
      {% for image in visit.images.all %}
        <img src="{{ image.image.url }}"
             alt="訪問画像"
             class="visit-photo"
             data-visit-date="{{ visit.date|date:'Y/m/d' }}">
      {% endfor %}
    {% endfor %}
  {% else %}
    <div class="no-photo">
      写真はまだ登録されていません
    </div>
  {% endif %}

</div>



  <!-- 店舗情報 -->
  <div class="restaurant-info">
    <h2>{{ restaurant.store_name }}</h2>

    <p class="meta-line">
  {% if restaurant.area %}
    {{ restaurant.area }}　
  {% endif %}

  {% if restaurant.genre %}
    {{ restaurant.genre }}　
  {% endif %}

  {% if restaurant.scene and restaurant.scene != "None" %}
    {{ restaurant.scene }}　
  {% endif %}

  {% if restaurant.companions and restaurant.companions != "None" %}
    {{ restaurant.companions }}
  {% endif %}
</p>

    {% if restaurant.tags.all %}
      <p class="meta-line">
        {% for tag in restaurant.tags.all %}
          {{ tag.name }}{% if not forloop.last %}　{% endif %}
        {% endfor %}
      </p>
    {% endif %}

    {% if restaurant.holiday %}
      <p class="meta-line">休業日　{{ restaurant.holiday }}</p>
    {% endif %}
    
  <!-- 店の削除 ＋ 再訪 -->
<div class="restaurant-buttons">

  <!-- 再訪（店単位） -->
  <form action="{% url 'restaurants:visit_revisit_store' restaurant.pk %}" method="get" class="action-form">
    <button type="submit" class="btn-revisit-store">再訪</button>
  </form>

 <!-- 店削除 -->
<form method="post"
      action="{% url 'restaurants:restaurant_reset' restaurant.pk %}"
      class="action-form">
  {% csrf_token %}
  <button type="button" 
          class="btn-delete open-delete-modal"
          data-url="{% url 'restaurants:restaurant_reset' restaurant.pk %}"
          data-message="このお店を「気になる」に戻しますか？">
    削除
  </button>
</form>
</div>

<!-- 店舗編集 -->
<div class="edit-store-wrapper">
  <a href="{% url 'restaurants:restaurant_edit' restaurant.pk %}?from=went" class="btn-edit-store">
  店舗情報を編集
</a>
</div>

  </div>

  <hr class="divider">

  <!-- 訪問履歴カード -->
  <div class="visit-history">
    {% if visits %}
      {% for visit in visits %}
        <div class="visit-card">
          <p class="meta-line">訪問日　{{ visit.date|date:"Y年 n月 j日" }}</p>
          <p class="meta-line">
            評価　
            {% if visit.feeling %}
            {{ visit.get_feeling_display }}
            {% else %}
            なし
            {% endif %}
          </p>


  <div class="stars">
      {% with r=visit.rating|default:0 %}
        {% for i in "12345" %}
          {% if forloop.counter <= r %}
            <span class="star filled">★</span>
          {% else %}
            <span class="star">★</span>
          {% endif %}
        {% endfor %}
      {% endwith %}
  </div>

{% if visit.comment %}
  <p class="comment">{{ visit.comment|linebreaksbr }}</p>
{% endif %}


         <div class="visit-buttons">

  <!-- 編集 -->
  <form action="{% url 'restaurants:visit_edit' visit.pk %}" method="get" class="visit-action-form">
    <button class="btn-edit">編集</button>
  </form>

  <!-- 訪問削除 -->
<form method="post"
      action="{% url 'restaurants:visit_delete' visit.pk %}" 
      class="visit-action-form">
  {% csrf_token %}
  <button type="button"
          class="btn-delete-visit open-delete-modal"
          data-url="{% url 'restaurants:visit_delete' visit.pk %}"
          data-message="この訪問記録を削除しますか？">
    削除
  </button>
</form>

</div>

        </div>
      {% endfor %}
    {% else %}
      <p class="no-visit-message">まだ訪問履歴がありません</p>
    {% endif %}
  </div>


  <!-- 戻るリンク -->
  <div class="back-link">
    <a href="{% url 'restaurants:restaurant_list_went' %}">一覧へ戻る</a>
  </div>
</div>

<!-- 画像拡大モーダル -->
<div id="image-modal" class="image-modal">
  <span class="close-modal">×</span>

  <div class="modal-inner">
    <img id="modal-img" class="modal-content">
    <p id="modal-date" class="modal-date"></p>
  </div>

  <p id="modal-visit-date" class="modal-visit-date"></p>

</div>

<script src="{% static 'restaurants/js/star_rating.js' %}"></script>


<!-- 汎用削除モーダル（写真と同じデザイン） -->
<div id="delete-modal" class="confirm-modal" style="display: none;">
  <div class="confirm-content">
    <p id="delete-message">本当に削除しますか？</p>

    <div class="confirm-buttons">
      <button type="button" id="cancel-delete" class="btn-cancel">キャンセル</button>

      <form id="delete-form" method="POST" style="margin: 0;">
        {% csrf_token %}
        <button type="submit" class="btn-ok">削除する</button>
      </form>
    </div>

  </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", () => {

  const modal = document.getElementById("delete-modal");
  const msg = document.getElementById("delete-message");
  const form = document.getElementById("delete-form");
  const cancel = document.getElementById("cancel-delete");

  // 削除ボタンが押されたらモーダルを開く
  document.querySelectorAll(".open-delete-modal").forEach(btn => {
    btn.addEventListener("click", () => {
      msg.textContent = btn.dataset.message;
      form.action = btn.dataset.url;
      modal.style.display = "flex";
    });
  });

  // キャンセル
  cancel.addEventListener("click", () => {
    modal.style.display = "none";
  });
});
</script>

{% endblock %}
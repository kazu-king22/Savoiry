{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal.css' %}">
{% block extra_css %}
  {{ block.super }}
{% endblock %}

  </head>
  <body>
<script>
  
  window.__sv_messages = [];
</script>

  {% if messages %}
<script>
  window.__sv_messages = [
    {% for m in messages %}"{{ m|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}
  ];
</script>
{% endif %}

    <header class="brand-header">
      Savoiry
    </header>

    <main class="main-content">
      {% block content %}{% endblock %}
    </main>

    {% if user.is_authenticated %}
    <nav class="bottom-nav">
  <ul>
    <li class="{% if request.resolver_match.url_name == 'restaurant_search' %}active{% endif %}">
      <a href="{% url 'restaurants:restaurant_search' %}">
        <img src="{% static 'icons/home.png' %}" 
             data-active="{% static 'icons/home_color.png' %}" 
             alt="ホーム" class="nav-icon"><br>ホーム
      </a>
    </li>
    <li class="{% if request.resolver_match.url_name == 'restaurant_add' %}active{% endif %}">
      <a href="{% url 'restaurants:restaurant_add' %}">
        <img src="{% static 'icons/recode.png' %}" 
             data-active="{% static 'icons/recode_color.png' %}" 
             alt="登録" class="nav-icon"><br>登録
      </a>
    </li>
    <li class="{% if request.resolver_match.url_name == 'restaurant_list_want' %}active{% endif %}">
      <a href="{% url 'restaurants:restaurant_list_want' %}">
        <img src="{% static 'icons/want.png' %}" 
             data-active="{% static 'icons/want_color.png' %}" 
             alt="気になる" class="nav-icon"><br>気になる
      </a>
    </li>
    <li class="{% if request.resolver_match.url_name == 'restaurant_list_went' %}active{% endif %}">
      <a href="{% url 'restaurants:restaurant_list_went' %}">
        <img src="{% static 'icons/went.png' %}" 
             data-active="{% static 'icons/went_color.png' %}" 
             alt="行った" class="nav-icon"><br>行った
      </a>
    </li>
    <li class="{% if request.resolver_match.url_name == 'mypage' %}active{% endif %}">
      <a href="{% url 'accounts:mypage' %}">
        <img src="{% static 'icons/account.png' %}" 
             data-active="{% static 'icons/account_color.png' %}" 
             alt="アカウント" class="nav-icon"><br>アカウント
      </a>
      </li>
    </ul>
  </nav>
  {% endif %}

  <script>
function showModal(content) {
  const modal = document.createElement("div");
  modal.classList.add("modal-overlay");
  modal.innerHTML = `
    <div class="modal">
      <p class="modal-title">${content.l1}</p>
      <p class="modal-message">${content.l2}</p>
      ${content.buttonText ? `<button class="modal-btn">${content.buttonText}</button>` : ""}
    </div>
  `;
  document.body.appendChild(modal);

  const button = modal.querySelector(".modal-btn");
  if (button && content.action) {
    button.addEventListener("click", content.action);
  }

  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.remove();
  });
}

const map = {
  email_changed: {
    l1: "メールアドレスを変更しました",
    l2: "次回ログイン時は新しいメールアドレスをご使用ください",
    buttonText: "OK",
    action: () => document.querySelector(".modal-overlay").remove(),
  },
  password_changed: {
    l1: "パスワードを変更しました",
    l2: "次回ログイン時は新しいパスワードをご使用ください",
    buttonText: "OK",
    action: () => document.querySelector(".modal-overlay").remove(),
  },
  login_first: {
    l1: "Savoiryへようこそ！！<br>アカウント登録が完了しました。",
    l2: "✓ 気になるお店を登録する<br>✓ 実際にお店を訪問する<br>✓ 行った感想を記録する",
    buttonText: "OK",
    action: () => window.location.href = "/savoiry/restaurants/search/",
  },
  restaurant_added: {
    l1: "✓ お店を登録しました！",
    l2: "・『気になる』一覧で確認できます",
    buttonText: "閉じる",
    action: () => document.querySelector(".modal-overlay").remove(),
  },
  went_added: {
  l1: "『行った』お店が増えました！",
  l2: "行った一覧ページで確認できます。",
  buttonText: "閉じる",
  action: () => window.location.href = "/savoiry/restaurants/went/",
　},
};


if (window.__sv_messages) {
  for (const key of window.__sv_messages) {
    if (map[key]) {
      showModal(map[key]);
      break;
    }
  }
}
</script>

{% if messages %}
<div id="toast-container"></div>
<script>
  const toastContainer = document.getElementById("toast-container");

  {% for message in messages %}
    const msg = "{{ message|escapejs }}";
    if (!["login_first", "email_changed", "password_changed", "restaurant_added","メールアドレス変更に失敗しました","パスワード変更に失敗しました","went_added","アカウント登録に失敗しました。"].includes(msg)) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = msg;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("show");
      }, 100);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  {% endfor %}
</script>
{% endif %}

{% block extra_js %}{% endblock %}
  </body>
</html>